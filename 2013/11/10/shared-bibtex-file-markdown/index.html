<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8" />
   <link rel="stylesheet" href="/css/normalize.css">
	<link rel="stylesheet" href="/css/foundation.min.css">
   <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css" rel="stylesheet">
   <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
	<link rel="stylesheet" href="/css/d3.css" />
	<link rel="stylesheet" href="/css/pygments.css" />
   <link rel="stylesheet/less" type="text/css" href="/css/tim.less" />
   <script type="text/javascript" src="/lib/less.js"></script>
   <script src="http://d3js.org/d3.v3.min.js"></script>
   <link rel="alternate" type="application/atom+xml" title="RSS Feed for Tim's blog" href="http://feeds.feedburner.com/timpoisot" />
    
    <script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-11830706-1']);
		_gaq.push(['_trackPageview']);

		(function() {
		 var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		 ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		 var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>
	
	<meta name="author" content="Tim Poisot" />
   <title>Timothée Poisot :: Collaborating with markdown and bibtex</title>
    
</head>

<body>
<a id="top"></a>
<div id="main">

<div class="row content">
   <div class = "row copy">
   <div class="large-9 small-10 columns maintext">
   <div class='post'>
<h1>Collaborating with markdown and bibtex</h1>

   <div class="postinfo">
      November 10, 2013 &mdash; <span class="label radius small secondary" style="margin-right: 3px;"><a href="/tag/bibtex/">bibtex</a></span><span class="label radius small secondary" style="margin-right: 3px;"><a href="/tag/scholarly markdown/">scholarly markdown</a></span><span class="label radius small secondary" style="margin-right: 3px;"><a href="/tag/python/">python</a></span>
   </div>


<p>The single most annoying issue when using <code>pandoc</code> to work collaboratively on
papers is that it might be difficult for other people to compile the paper if
they do not use your bibtex file. And if there is ony thing I avoid like the
plague, it&#39;s having several bibtex files all over the place. And I&#39;m can&#39;t
be bothered to keep &ldquo;Collections&rdquo; or separate folders in Zotero. So clearly,
I had to code my way out of this one.</p>

<p>The good thing of using <code>pandoc</code> is that the citation syntax is remarkably
simple: <code>@key</code>. It means that using a simple <code>grep</code> command</p>

<div class="highlight"><pre><code class="bash">grep @<span class="o">[</span>-:_a-zA-Z0-9<span class="o">]</span>* ms.md -oh --color<span class="o">=</span>never | sort  | uniq -u | sed <span class="s1">&#39;s/@//g&#39;</span> &gt; bib.keys
</code></pre></div>

<p>, I can generate <code>bib.keys</code>, a list with all the keys encountered in
<code>ms.md</code>. The keys will be present only once, and sorted. The first few lines
of one such file are</p>

<div class="highlight"><pre><code class="text">allesina_competitive_2011
angilletta_temperature_2004
araujo_using_2011
baiser_geographic_2012
baskerville_spatial_2011
bluthgen_what_2008
</code></pre></div>

<p>Now, I need to take each of these keys, read my big <code>library.bib</code> file, and
extract only the entries that are cited in the document. So I installed a
<a href="https://github.com/sciunto/python-bibtexparser">bibtex parser for python</a>, and started doing exactly that. The amazing
thing is, this only takes four (interesting) lines:</p>

<div class="highlight"><pre><code class="python"><span class="c">## Step 1 - read the key list</span>
<span class="n">keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">kl</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&quot;:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">kl</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">key_list</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)]</span>
<span class="c">## Step 2 - read the library file</span>
<span class="n">refs</span> <span class="o">=</span> <span class="n">BibTexParser</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">bib_file</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">get_entry_dict</span><span class="p">()</span>
<span class="c">## Step 3 - extract the used entries</span>
<span class="n">used_refs</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="ow">in</span> <span class="n">refs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">}</span>
<span class="c">## Step 4 - convert the dicts back into bibtex</span>
<span class="n">refs_as_bib</span> <span class="o">=</span> <span class="p">[</span><span class="n">dict2bib</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">used_refs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">()]</span>
<span class="k">print</span> <span class="p">[</span><span class="n">uk</span> <span class="k">for</span> <span class="n">uk</span> <span class="ow">in</span> <span class="n">keys</span> <span class="k">if</span> <span class="n">uk</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used_refs</span><span class="o">.</span><span class="n">keys</span><span class="p">()]</span>
<span class="c">## Step 5 - write the output file</span>
<span class="k">with</span> <span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">out_file</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">,</span> <span class="s">&#39;utf-8-sig&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">of</span><span class="p">:</span>
   <span class="n">of</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="n">refs_as_bib</span><span class="p">)</span>
</code></pre></div>

<p>This code will print a list of all the keys in the <code>bib.keys</code> that have
<em>not</em> been matched to an entry in the main library file. If all went well,
this list should be empty. I&#39;ve uploaded the whole file as a <a href="https://gist.github.com/tpoisot/7406955">gist</a>, if you
intend to use it.</p>

<p>And of course, you can nicely wrap things up in a <code>makefile</code>:</p>

<div class="highlight"><pre><code class="makefile"><span class="nv">python</span> <span class="o">=</span> python2
<span class="nv">refs</span> <span class="o">=</span> refs.bib
<span class="nv">text</span> <span class="o">=</span> ms.md
<span class="nv">library</span> <span class="o">=</span> /path/to/main/bibtex/file.bib

<span class="k">$(</span>refs<span class="k">)</span>: bib.keys
   <span class="k">$(</span>python<span class="k">)</span> extractbib.py bib.keys <span class="k">$(</span>library<span class="k">)</span> <span class="k">$(</span>refs<span class="k">)</span>

bib.keys: 
   grep @<span class="o">[</span>-:_a-zA-Z0-9<span class="o">]</span>* <span class="k">$(</span>text<span class="k">)</span> -oh --color<span class="o">=</span>never | sort  | uniq -u | sed <span class="s1">&#39;s/@//g&#39;</span> &gt; bib.keys
</code></pre></div>

<p>I&#39;m glad that I finally have a solution to this problem. Of course, a
multi-author version is not difficult to do (just have each author write
its own bibtex file, and put them all together before running <code>pandoc</code>). It
also means that my <code>pandoc</code>-using papers are going to finally be entirely
reproducible, as I&#39;ll distribute the references list in the <em>github</em>
repository.</p>


</div>



<div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'tpoi-hp'; // required: replace example with your forum shortname

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

<div class="pager">


<span class="previous">
   <a href="/2013/11/04/test-driven-python/"><i class="fa fa-fw fa-chevron-left"></i> Previous post</a>
</span>



<span class="next">
<a href="/2013/11/25/metapopulation-model-r/">Next post <i class="fa fa-fw fa-chevron-right"></i></a>
</span>

</div>


   </div>
   <div class="large-3 small-2 columns">
      <div class='header'>
         <h1>Timothée Poisot</h1>
<h2>Spatial ecology of species interactions</h2>

         <ul class="no-bullet main-nav">
   <li><a href="/">Home</a></li>
   <li><a href="/papers/">Papers</a></li>
   <li><a href="/software/">Software</a></li>
   <li><a href="/research/">Research</a></li>
   <li class="active"><a href="/blog/">Blog</a></li>
</ul>

         <a class='top' href="#top"><i class="fa fa-arrow-circle-up"></i></a>
      </div>
   </div>
   </div>

   <div class="row footer">
         <div class="small-4 columns">
<h5>Contact</h5>
<ul class='no-bullet'>
   <li><i class="fa fa-fw fa-envelope"></i> <a href="mailto:t.poisot@gmail.com">E-mail</a></li>
   <li><i class="fa fa-fw fa-twitter-square"></i> <code>@tpoi</code> on <a href="http://twitter.com/tpoi/">Twitter</a></li>
   <li><i class="fa fa-fw fa-github-square"></i> <code>tpoisot</code> on <a href="http://github.com/tpoisot/">GitHub</a></li>
   <li><i class="fa fa-fw fa-rss-square"></i> <a href="http://feeds.feedburner.com/timpoisot/">RSS feed for new posts</a></li>
</ul>
</div>

<div class="small-8 columns">
   <h5>Most recent posts</h5>
   <ul class='no-bullet'>
   
   <li><span class='date'>14 Jan 2014</span> <a href="/2014/01/14/filtering-in-mangal/">These aren't the networks you're looking for</a></li>
   
   <li><span class='date'>11 Jan 2014</span> <a href="/2014/01/11/animate-networks-with-igraph/">Animate networks with igraph</a></li>
   
   <li><span class='date'>09 Jan 2014</span> <a href="/2014/01/09/mangal-in-action/">Examples of mangal in action</a></li>
   
   <li><span class='date'>08 Jan 2014</span> <a href="/2014/01/08/mangal-add-data/">Uploading data into mangal</a></li>
   
   </ul>
</div>


<div class="small-8 columns">
   <h5>Colophon</h5>
   <p>
	  This website uses <a href='http://foundation.zurb.com/'>Foundation
	  5</a>, <a href='http://fortawesome.github.io/Font-Awesome/'>Font
	  Awesome</a>, is built with <a
	  href='https://github.com/mojombo/jekyll'>Jekyll</a>, and hosted by <a
	  href='http://pages.github.com/'>GitHub pages</a>. Contents under the
	  <a href='http://creativecommons.org/licenses/by-sa/3.0/deed.en_US'>CC
	  BY-SA 3.0</a> licence.
   </p>
</div>


   </div>

</div>


</div>

</body>

</html>
